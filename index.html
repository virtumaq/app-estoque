// ===== SISTEMA DE AUTENTICAÇÃO =====

// Verificar se usuário está logado
function verificarLogin() {
    const usuarioLogado = localStorage.getItem('usuarioLogado');
    
    if (!usuarioLogado) {
        // Redirecionar para login se não estiver logado
        window.location.href = 'login.html';
        return null;
    }
    
    try {
        return JSON.parse(usuarioLogado);
    } catch (error) {
        console.error('Erro ao ler dados do usuário:', error);
        logout();
        return null;
    }
}

// Função de logout
function logout() {
    localStorage.removeItem('usuarioLogado');
    window.location.href = 'login.html';
}

// Verificar permissões do usuário
function temPermissao(acaoNecessaria) {
    const usuario = verificarLogin();
    if (!usuario) return false;
    
    const permissoes = {
        'admin': ['criar', 'editar', 'deletar', 'visualizar', 'gerenciar_usuarios'],
        'gerente': ['criar', 'editar', 'visualizar'],
        'usuario': ['visualizar']
    };
    
    return permissoes[usuario.cargo]?.includes(acaoNecessaria) || false;
}

// Mostrar/ocultar elementos baseado em permissões
function configurarPermissoes() {
    const usuario = verificarLogin();
    if (!usuario) return;
    
    // Ocultar botões baseado no cargo
    if (!temPermissao('criar')) {
        const botoesAdicionar = document.querySelectorAll('.btn-adicionar, #productForm');
        botoesAdicionar.forEach(btn => {
            if (btn) btn.style.display = 'none';
        });
    }
    
    if (!temPermissao('editar')) {
        const botoesEditar = document.querySelectorAll('.btn-editar');
        botoesEditar.forEach(btn => {
            if (btn) btn.style.display = 'none';
        });
    }
    
    if (!temPermissao('deletar')) {
        const botoesDeletar = document.querySelectorAll('.btn-deletar');
        botoesDeletar.forEach(btn => {
            if (btn) btn.style.display = 'none';
        });
    }
    
    // Adicionar informações do usuário no header
    adicionarInfoUsuario(usuario);
}

// Adicionar informações do usuário no header
function adicionarInfoUsuario(usuario) {
    const header = document.querySelector('.header');
    if (!header) return;
    
    // Criar div de informações do usuário
    const userInfo = document.createElement('div');
    userInfo.className = 'user-info';
    userInfo.innerHTML = `
        <style>
            .user-info {
                position: absolute;
                top: 20px;
                right: 20px;
                background: white;
                padding: 12px 16px;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                display: flex;
                align-items: center;
                gap: 12px;
                font-size: 0.9rem;
            }
            
            .user-avatar {
                width: 32px;
                height: 32px;
                background: #6366f1;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: 600;
                font-size: 0.8rem;
            }
            
            .user-details {
                display: flex;
                flex-direction: column;
            }
            
            .user-name {
                font-weight: 600;
                color: #1a1a1a;
            }
            
            .user-role {
                font-size: 0.8rem;
                color: #6b7280;
                text-transform: capitalize;
            }
            
            .logout-btn {
                background: #ef4444;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.8rem;
                transition: background 0.2s;
            }
            
            .logout-btn:hover {
                background: #dc2626;
            }
            
            @media (max-width: 768px) {
                .user-info {
                    position: relative;
                    top: auto;
                    right: auto;
                    margin: 16px auto 0;
                    width: fit-content;
                }
            }
        </style>
        
        <div class="user-avatar">
            ${usuario.nome.charAt(0).toUpperCase()}
        </div>
        
        <div class="user-details">
            <div class="user-name">${usuario.nome}</div>
            <div class="user-role">${usuario.cargo}</div>
        </div>
        
        <button class="logout-btn" onclick="logout()">
            Sair
        </button>
    `;
    
    header.style.position = 'relative';
    header.appendChild(userInfo);
}

// Registrar ação do usuário (opcional - para auditoria)
async function registrarAcao(acao, detalhes = '') {
    const usuario = verificarLogin();
    if (!usuario) return;
    
    try {
        // Você pode criar uma tabela 'logs' para registrar ações
        console.log(`[${new Date().toISOString()}] ${usuario.nome} (${usuario.cargo}): ${acao}`, detalhes);
        
        // Opcional: salvar no Supabase
        /*
        await supabaseClient
            .from('logs')
            .insert({
                usuario_id: usuario.id,
                acao: acao,
                detalhes: detalhes,
                timestamp: new Date().toISOString()
            });
        */
    } catch (error) {
        console.error('Erro ao registrar ação:', error);
    }
}

// Inicializar sistema de autenticação quando a página carregar
window.addEventListener('DOMContentLoaded', () => {
    // Verificar login primeiro
    const usuario = verificarLogin();
    
    if (usuario) {
        // Configurar permissões após verificar login
        setTimeout(configurarPermissoes, 100);
        
        // Registrar acesso
        registrarAcao('Acessou o sistema');
        
        console.log(`✅ Usuário logado: ${usuario.nome} (${usuario.cargo})`);
    }
});

// ===== MODIFICAÇÕES NAS FUNÇÕES EXISTENTES =====

// Modificar função de adicionar produto para verificar permissão
const addProductOriginal = window.addProduct || function() {};
window.addProduct = async function(data) {
    if (!temPermissao('criar')) {
        alert('Você não tem permissão para adicionar produtos');
        return;
    }
    
    await registrarAcao('Adicionou produto', `ID: ${data.id}`);
    return addProductOriginal(data);
};

// Modificar função de editar produto
const editProductOriginal = window.editProduct || function() {};
window.editProduct = function(id) {
    if (!temPermissao('editar')) {
        alert('Você não tem permissão para editar produtos');
        return;
    }
    
    registrarAcao('Iniciou edição de produto', `ID: ${id}`);
    return editProductOriginal(id);
};

// Modificar função de deletar produto
const deleteProductOriginal = window.deleteProduct || function() {};
window.deleteProduct = function(id) {
    if (!temPermissao('deletar')) {
        alert('Você não tem permissão para deletar produtos');
        return;
    }
    
    registrarAcao('Tentou deletar produto', `ID: ${id}`);
    return deleteProductOriginal(id);
};
